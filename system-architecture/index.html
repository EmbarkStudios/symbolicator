<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>System Architecture - Symbolicator</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "System Architecture";
    var mkdocs_page_input_path = "system-architecture.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../js/jquery-2.1.1.min.js" defer></script>
  <script src="../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Symbolicator</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Symbolicator</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../background-and-principles/">Background and Principles</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../caching/">Internal Caching</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../symbol-lookup/">Symbol lookup strategy</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../symbol-server-compatibility/">Symbol Server Compatibility</a>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../symbolication-api/">Symbolication API</a>
	    </li>
          
            <li class="toctree-l1 current">
		
    <a class="current" href="./">System Architecture</a>
    <ul class="subnav">
            
    <li class="toctree-l2"><a href="#system-architecture">System Architecture</a></li>
    
        <ul>
        
            <li><a class="toctree-l3" href="#looking-up-debugunwind-information">Looking up debug/unwind information</a></li>
        
        </ul>
    

    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Symbolicator</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>System Architecture</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="system-architecture">System Architecture</h1>
<p>This page describes the internal structure and processes of Symbolicator.</p>
<h2 id="looking-up-debugunwind-information">Looking up debug/unwind information</h2>
<p>When finding an object file for a image in a symbolication request, we do the following:</p>
<ol>
<li>
<p>We generate all possible file downloads for each source, based on platform
  information and source filters. See <a href="../symbol-lookup/">Symbol Lookup</a>.</p>
</li>
<li>
<p>We download all files we can get and cache them keyed by source ID and
   filepath (<code>ObjectFile</code>).</p>
</li>
<li>
<p>Then we rank all downloaded files:</p>
</li>
<li>
<p>Objects with debug or unwind information (depending on what we want to use the object for) are ranked at the top.</p>
</li>
<li>Objects with a symbol table are ranked second.</li>
<li>
<p>Unparseable objects are ranked somewhere at the bottom together with empty files, 404s etc.</p>
</li>
<li>
<p>Then we generate a symcache or cficache from the best file, save it also keyed by source ID and filepath. In the cache dir, a symcache file now basically has the same filename as an object file, just in a different folder.</p>
</li>
</ol>
<h3 id="objectmeta"><code>ObjectMeta</code></h3>
<p>The issue with the above setup is that one would have to have all objects permanently persisted on disk to be able to decide which symcache to use, which is only feasible in a world with infinite disk space.</p>
<p>For this purpose we have the concept of an <code>ObjectMeta</code> cache, which stores information about the quality of an <code>ObjectFile</code> and is persisted for much longer. <code>ObjectFile</code>s are deleted just a few days after download while <code>ObjectMeta</code>s stick around for as long as the symcache/cficache does.</p>
<h3 id="the-object-cache-key">The object cache key</h3>
<p>As mentioned earlier, <code>ObjectFile</code>s, symcaches/cficaches (and <code>ObjectMeta</code>s) are cached by source ID and filepath. What this actually means depends on the source type:</p>
<ul>
<li>For the HTTP source type (Microsoft SymStore etc) this is just the source ID
  as given in the symbolication request + the filepath of the download URL.</li>
<li>For S3 and GCS buckets this is the source ID and the object key/path (object
  as in S3 object).</li>
<li>For the Sentry source type this is the source ID and the numeric "Debug File
  Id".</li>
</ul>
<p>In summary, the cache key is just whatever is necessary to uniquely identify a file
within a source.</p>
<h3 id="generating-all-possible-file-downloads-for-a-source">Generating all possible file downloads for a source</h3>
<p>In step 1, we mentioned that we generate all possible file downloads. For most filesystem-like source types this is a simple computation that takes an <code>ObjectId</code> (really a quintuple of debug and code ID + debug name + code name) and generates possible filepaths. The logic for this lives in <code>src/utils/paths.rs</code>.</p>
<p>For the Sentry source type, this looks a bit different. Since Sentry already builds some sort of index based on debug and code ID, we first have to issue an HTTP request to Sentry to search for files based on those IDs. We get back a list of numeric "Debug File Ids" (those are just the integer PK in Postgres) that we then can download one by one.</p>
<p>Since this step is quite expensive for Sentry, it is cached separately. This part is currently WIP.</p>
<h3 id="example">Example</h3>
<p>The logic for looking up debug information for an image looks as follows (simplified, conflating code_name vs debug_name + code_id vs debug_id):</p>
<ul>
<li>Lookup of object <code>name=wkernel32.pdb, id=0xdeadbeef</code> (uncached, parallelized):</li>
<li>(cached) Fetching sentry index for <code>id=0xdeadbeef</code> (uncached) -&gt; returns <code>[123456]</code></li>
<li>(cached) lookup of object <em>metadata</em> <code>[sentry, 123456]</code> -&gt; returns <code>has_debug_info=true, ...</code><ul>
<li>(cached) lookup of object <em>file</em> <code>[sentry, 123456]</code></li>
</ul>
</li>
<li>(cached) lookup of object <em>metadata</em> <code>[microsoft, /wkernel32.pdb/deadbeef/wkernel32.pdb]</code> -&gt; returns <code>has_debug_info=false, ...</code><ul>
<li>(cached) lookup of object <em>file</em> <code>[microsoft, /wkernel32.pdb/deadbeef/wkernel32.pdb]</code></li>
</ul>
</li>
<li>Sentry project symbol wins, because it has more than symbol table</li>
<li>(cached) lookup of symcache <code>[sentry, 123456]</code></li>
</ul>
<p>All steps that are behind a caching layer are prefixed with <code>(cached)</code>. If a cache hit occurs, the sub-bulletpoints are not executed.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
      
        <a href="../symbolication-api/" class="btn btn-neutral" title="Symbolication API"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../symbolication-api/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js" defer></script>
      <script src="../search/main.js" defer></script>

</body>
</html>
