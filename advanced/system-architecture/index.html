



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
        <meta name="author" content="Sentry">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>System Architecture - Sentry Symbolicator</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../_css/extra.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
          <svg xmlns="http://www.w3.org/2000/svg" width="416" height="448" viewBox="0 0 416 448" id="__github"><path fill="currentColor" d="M160 304q0 10-3.125 20.5t-10.75 19T128 352t-18.125-8.5-10.75-19T96 304t3.125-20.5 10.75-19T128 256t18.125 8.5 10.75 19T160 304zm160 0q0 10-3.125 20.5t-10.75 19T288 352t-18.125-8.5-10.75-19T256 304t3.125-20.5 10.75-19T288 256t18.125 8.5 10.75 19T320 304zm40 0q0-30-17.25-51T296 232q-10.25 0-48.75 5.25Q229.5 240 208 240t-39.25-2.75Q130.75 232 120 232q-29.5 0-46.75 21T56 304q0 22 8 38.375t20.25 25.75 30.5 15 35 7.375 37.25 1.75h42q20.5 0 37.25-1.75t35-7.375 30.5-15 20.25-25.75T360 304zm56-44q0 51.75-15.25 82.75-9.5 19.25-26.375 33.25t-35.25 21.5-42.5 11.875-42.875 5.5T212 416q-19.5 0-35.5-.75t-36.875-3.125-38.125-7.5-34.25-12.875T37 371.5t-21.5-28.75Q0 312 0 260q0-59.25 34-99-6.75-20.5-6.75-42.5 0-29 12.75-54.5 27 0 47.5 9.875t47.25 30.875Q171.5 96 212 96q37 0 70 8 26.25-20.5 46.75-30.25T376 64q12.75 25.5 12.75 54.5 0 21.75-6.75 42 34 40 34 99.5z"/></svg>
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#system-architecture" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../.." title="Sentry Symbolicator" class="md-header-nav__button md-logo">
          
            <img src="../../_static/icon.png" width="24" height="24">
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic">
              Sentry Symbolicator
            </span>
            <span class="md-header-nav__topic">
              
                System Architecture
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  

<a href="https://github.com/getsentry/symbolicator/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../.." title="Sentry Symbolicator" class="md-nav__button md-logo">
      
        <img src="../../_static/icon.png" width="48" height="48">
      
    </a>
    Sentry Symbolicator
  </label>
  
    <div class="md-nav__source">
      


  

<a href="https://github.com/getsentry/symbolicator/" title="Go to repository" class="md-source" data-md-source="github">
  
    <div class="md-source__icon">
      <svg viewBox="0 0 24 24" width="24" height="24">
        <use xlink:href="#__github" width="24" height="24"></use>
      </svg>
    </div>
  
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Introduction" class="md-nav__link">
      Introduction
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Advanced
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Advanced
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../caching/" title="Caching" class="md-nav__link">
      Caching
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        System Architecture
      </label>
    
    <a href="./" title="System Architecture" class="md-nav__link md-nav__link--active">
      System Architecture
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#looking-up-debugunwind-information" title="Looking up debug/unwind information" class="md-nav__link">
    Looking up debug/unwind information
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#objectmeta" title="ObjectMeta" class="md-nav__link">
    ObjectMeta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-object-cache-key" title="The object cache key" class="md-nav__link">
    The object cache key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-all-possible-file-downloads-for-a-source" title="Generating all possible file downloads for a source" class="md-nav__link">
    Generating all possible file downloads for a source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" title="Example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../background-and-principles/" title="Background and Principles" class="md-nav__link">
      Background and Principles
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../symbol-lookup/" title="Lookup Strategy" class="md-nav__link">
      Lookup Strategy
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../symbol-server-compatibility/" title="Symbol Server Compatibility" class="md-nav__link">
      Symbol Server Compatibility
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      API
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/" title="Overview" class="md-nav__link">
      Overview
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/minidump/" title="POST /minidump" class="md-nav__link">
      POST /minidump
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/symbolication/" title="POST /symbolicate" class="md-nav__link">
      POST /symbolicate
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/applecrashreport/" title="POST /applecrashreport" class="md-nav__link">
      POST /applecrashreport
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/response/" title="Symbolication Response" class="md-nav__link">
      Symbolication Response
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../api/proxy/" title="Symbol Server Proxy" class="md-nav__link">
      Symbol Server Proxy
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#looking-up-debugunwind-information" title="Looking up debug/unwind information" class="md-nav__link">
    Looking up debug/unwind information
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#objectmeta" title="ObjectMeta" class="md-nav__link">
    ObjectMeta
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#the-object-cache-key" title="The object cache key" class="md-nav__link">
    The object cache key
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#generating-all-possible-file-downloads-for-a-source" title="Generating all possible file downloads for a source" class="md-nav__link">
    Generating all possible file downloads for a source
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#example" title="Example" class="md-nav__link">
    Example
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/getsentry/symbolicator/edit/master/docs/advanced/system-architecture.md" title="Edit this page" class="md-icon md-content__icon">&#xE3C9;</a>
                
                
                <h1 id="system-architecture">System Architecture</h1>
<p>This page describes the internal structure and processes of Symbolicator.</p>
<h2 id="looking-up-debugunwind-information">Looking up debug/unwind information</h2>
<p>When finding an object file for a image in a symbolication request, we do the
following:</p>
<ol>
<li>We generate all possible file downloads for each source, based on platform
   information and source filters. See <a href="../symbol-lookup/">Symbol Lookup</a>.</li>
<li>We download all files we can get and cache them keyed by source ID and
   filepath (<code>ObjectFile</code>).</li>
<li>Then we rank all downloaded files:<ol>
<li>Objects with debug or unwind information (depending on what we want to use
   the object for) are ranked at the top.</li>
<li>Objects with a symbol table are ranked second.</li>
<li>Unparseable objects are ranked somewhere at the bottom together with empty
   files, 404s etc.</li>
</ol>
</li>
<li>Then we generate a symcache or cficache from the best file, save it also
   keyed by source ID and filepath. In the cache dir, a symcache file now
   basically has the same filename as an object file, just in a different
   folder.</li>
</ol>
<h3 id="objectmeta"><code>ObjectMeta</code></h3>
<p>The issue with the above setup is that one would have to have all objects
permanently persisted on disk to be able to decide which symcache to use, which
is only feasible in a world with infinite disk space.</p>
<p>For this purpose we have the concept of an <code>ObjectMeta</code> cache, which stores
information about the quality of an <code>ObjectFile</code> and is persisted for much
longer. <code>ObjectFile</code>s are deleted just a few days after download while
<code>ObjectMeta</code>s stick around for as long as the symcache/cficache does.</p>
<h3 id="the-object-cache-key">The object cache key</h3>
<p>As mentioned earlier, <code>ObjectFile</code>s, symcaches/cficaches (and <code>ObjectMeta</code>s) are
cached by source ID and filepath. What this actually means depends on the source
type:</p>
<ul>
<li>For the HTTP source type (Microsoft SymStore etc) this is just the source ID
  as given in the symbolication request + the filepath of the download URL.</li>
<li>For S3 and GCS buckets this is the source ID and the object key/path (object
  as in S3 object).</li>
<li>For the Sentry source type this is the source ID and the numeric "Debug File
  Id".</li>
</ul>
<p>In summary, the cache key is just whatever is necessary to uniquely identify a
file within a source.</p>
<h3 id="generating-all-possible-file-downloads-for-a-source">Generating all possible file downloads for a source</h3>
<p>In step 1, we mentioned that we generate all possible file downloads. For most
filesystem-like source types this is a simple computation that takes an
<code>ObjectId</code> (really a quintuple of debug and code ID + debug name + code name)
and generates possible filepaths. The logic for this lives in
<code>src/utils/paths.rs</code>.</p>
<p>For the Sentry source type, this looks a bit different. Since Sentry already
builds some sort of index based on debug and code ID, we first have to issue an
HTTP request to Sentry to search for files based on those IDs. We get back a
list of numeric "Debug File Ids" (those are just the integer PK in Postgres)
that we then can download one by one.</p>
<p>Since this step is quite expensive for Sentry, it is cached separately. This
part is currently WIP.</p>
<h3 id="example">Example</h3>
<p>The logic for looking up debug information for an image looks as follows
(simplified, conflating code_name vs debug_name + code_id vs debug_id):</p>
<ul>
<li>Lookup of object <code>name=wkernel32.pdb, id=0xdeadbeef</code> (uncached, parallelized):<ul>
<li>(cached) Fetching sentry index for <code>id=0xdeadbeef</code> (uncached) -&gt; returns
  <code>[123456]</code></li>
<li>(cached) lookup of object <em>metadata</em> <code>[sentry, 123456]</code> -&gt; returns
  <code>has_debug_info=true, ...</code><ul>
<li>(cached) lookup of object <em>file</em> <code>[sentry, 123456]</code></li>
</ul>
</li>
<li>(cached) lookup of object <em>metadata</em> <code>[microsoft,
  /wkernel32.pdb/deadbeef/wkernel32.pdb]</code> -&gt; returns <code>has_debug_info=false,
  ...</code><ul>
<li>(cached) lookup of object <em>file</em> <code>[microsoft,
  /wkernel32.pdb/deadbeef/wkernel32.pdb]</code></li>
</ul>
</li>
<li>Sentry project symbol wins, because it has more than symbol table</li>
</ul>
</li>
<li>(cached) lookup of symcache <code>[sentry, 123456]</code></li>
</ul>
<p>All steps that are behind a caching layer are prefixed with <code>(cached)</code>. If a
cache hit occurs, the sub-bulletpoints are not executed.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../caching/" title="Caching" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Caching
              </span>
            </div>
          </a>
        
        
          <a href="../background-and-principles/" title="Background and Principles" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Background and Principles
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>